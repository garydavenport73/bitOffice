let contactsTableElement=document.getElementById("contacts-table"),contactsEditForm=document.getElementById("contacts-edit-form"),contactsEditFormMessage=document.getElementById("contacts-edit-form-message"),contactsSortAscending=1,contactsTable={name:"Contacts",headers:["First Name","Middle Name","Last Name","Mobile Phone","Home Phone","Business Phone","E-mail Address","Home Address","Notes"],inputTypes:{"First Name":"text","Middle Name":"text","Last Name":"text","Mobile Phone":"tel","Home Phone":"tel","Business Phone":"tel","E-mail Address":"email","Home Address":"textarea",Notes:"textarea"},data:[]},calendarTable=document.getElementById("calendar-table"),calendarEditForm=document.getElementById("calendar-edit-form"),calendarEditFormMessage=document.getElementById("calendar-edit-form-message"),monthChooser=document.getElementById("month-chooser"),daysAbbreviations=["Sun","Mon","Tue","Wed","Thur","Fri","Sat"],calendarSortAscending=1,calendarDatabase={name:"Calendar",headers:["Subject","Start Date","Start Time","End Date","End Time","Description","UID"],inputTypes:{Subject:"text","Start Date":"date","Start Time":"time","End Date":"date","End Time":"time",Description:"textarea",UID:"text"},data:[]},combinedDatabase={contacts:contactsTable,calendar:calendarDatabase};initializeCalendarApp();function initializeCalendarApp(){monthChooser.addEventListener("input",makeCalendar),monthChooser.addEventListener("change",makeCalendar),monthChooser.value=getTodaysDate().slice(0,-3),console.log(getTodaysDate().slice(0,-3)),makeCalendar()}function processCalendarHome(){makeCalendar(),showPlannerDiv("planner-calendar-start")}function processCalendarCSVClick(){let b=document.getElementById("calendar-date").value,a={};a.data=[];for(let c=0;c<calendarDatabase.data.length;c++)(b===calendarDatabase.data[c]["Start Date"]||b===calendarDatabase.data[c]["End Date"]||b>=calendarDatabase.data[c]["Start Date"]&&b<=calendarDatabase.data[c]["End Date"])&&a.data.push(calendarDatabase.data[c]);a.headers=calendarDatabase.headers,a=JSON.parse(JSON.stringify(a)),a.name="Calendar",processCSVClick(a)}function buildCalendarTableElement(d){let b=calendarDatabase.data,c=[],e=calendarDatabase.headers.length;for(let a=0;a<b.length;a++)if(d===b[a]["Start Date"]||d===b[a]["End Date"]||d>=b[a]["Start Date"]&&d<=b[a]["End Date"]){let d=JSON.parse(JSON.stringify(b[a]));d.intBaseIndex=a,c.push(d)}destructiveDoubleSortAscending(c,"Start Date","Start Time");let a="";a+="<table>",a+="<thead><tr>";for(let b=0;b<e;b++)a+="<th onclick='//sortCalendarByField(this);'>"+calendarDatabase.headers[b]+"</th>";a+="</tr></thead>",a+="<tbody>";for(let b=0;b<c.length;b++){a+="<tr id='calendar-table-row-"+b.toString()+"' onclick=\"selectCalendarEditForm("+c[b].intBaseIndex.toString()+')">';for(let d=0;d<e;d++){let f=calendarDatabase.headers[d];a+="<td><pre>"+c[b][f]+"</pre></td>"}a+="</tr>"}return a+="</tbody>",a}function newCalendarEntry(a){calendarEditFormMessage.innerHTML=document.getElementById("calendar-date").value+": New Entry",calendarEditForm.innerHTML=buildCalendarEditForm(-1),showPlannerDiv("planner-calendar-form")}function selectCalendarEditForm(a){calendarEditFormMessage.innerHTML=document.getElementById("calendar-date").value+": Entry "+a.toString(),calendarEditForm.innerHTML=buildCalendarEditForm(a),showPlannerDiv("planner-calendar-form")}function buildCalendarEditForm(c){let f=document.getElementById("calendar-date").value,g=calendarDatabase.data[c],b="";b+="<form>",b="<input type='hidden' id='calendar-row-index' value='"+c.toString()+"'>";let h=calendarDatabase.headers.length,a=calendarDatabase.headers,e=g,d=calendarDatabase.inputTypes;for(let g=0;g<h;g++){let i="";if(d[a[g]]==="number"?i=" step='any' ":d[a[g]]==="tel"&&(i=" placeholder='304-424-1000' pattern='[0-9]{3}-[0-9]{3}-[0-9]{4}' "),a[g]==="Start Date"&&c===-1&&(i="value="+f),a[g]==="End Date"&&c===-1&&(i="value="+f),a[g]==="UID"&&(i="disabled"),d[a[g]]!=="textarea")console.log("not textarea"),c===-1?b+="<div><label for='"+a[g]+"'>"+a[g]+"</label></div><div><input type='"+d[a[g]]+"' id='"+a[g]+"' "+i+"></div>":b+="<div><label for='"+a[g]+"'>"+a[g]+"</label></div><div><input type='"+d[a[g]]+"' id='"+a[g]+"' value='"+e[a[g]].split('"').join("&quot;").split("'").join("&apos;")+"'"+i+"></div>";else if(console.log("textarea!"),c===-1)b+="<div><label for='"+a[g]+"'>"+a[g]+"</label></div><div><textarea id='"+a[g]+"' "+i+"></textarea></div>";else{let c=e[a[g]].split('"').join("&quot;").split("'").join("&apos;");console.log(c),b+="<div><label for='"+a[g]+"'>"+a[g]+"</label></div><div><textarea id='"+a[g]+"' "+i+">"+c+"</textarea></div>"}}return b+="</form>",b}function saveCalendarEntry(){let c=parseInt(document.getElementById("calendar-row-index").value),d=document.getElementById("calendar-date").value,b=calendarDatabase.headers,a={};for(let c=0;c<b.length;c++)a[b[c]]=document.getElementById(b[c]).value;a["Start Date"]===""&&(a["Start Date"]=d),a["Start Time"]===""&&(a["Start Time"]="00:00"),(a.UID===""||a.UID===void 0)&&(a.UID=makeUID(a["Start Date"],a["Start Time"])),c>=0?calendarDatabase.data[c]=a:calendarDatabase.data.push(a),clearCalendarFormEntries(),calendarTable.innerHTML=buildCalendarTableElement(d),showPlannerDiv("planner-calendar-table"),confirm("Current data updated.  Save updated data to file?")&&saveCombinedDatabase()}function exportSingleICalEvent(){let c=parseInt(document.getElementById("calendar-row-index").value),e=document.getElementById("calendar-date").value,b=calendarDatabase.headers,a={};for(let c=0;c<b.length;c++)a[b[c]]=document.getElementById(b[c]).value;(a.UID===""||a.UID===void 0)&&(a.UID=makeUID(a["Start Date"],a["Start Time"]),document.getElementById("UID").innerHTML=a.UID);let f=makeVEvent(a,"\n"),d=[];d.push(f);let g=makeVCalendar(d,"\n"),h="vEvent"+a["Start Date"]+"_"+a["Start Time"].replace(/\:/g,"");copyAndSaveString(g,h,".ical",mimeType="text/calendar"),c>=0?calendarDatabase.data[c]=a:calendarDatabase.data.push(a),alert("Entry also updated in calendar."),clearCalendarFormEntries(),calendarTable.innerHTML=buildCalendarTableElement(e),showPlannerDiv("planner-calendar-table")}function makeUID(b,c){let d=calendarDatabase.data,e=[];for(let a=0;a<d.length;a++)e.push(d[a].UID);let a="bitOffice."+ISOStringToICalStringZulu(htmlDateAndTimeToISOString(b,c))+Math.random().toString();while(e.includes(a))a="bitOffice."+ISOStringToICalStringZulu(htmlDateAndTimeToISOString(b,c))+Math.random().toString();return a}function purgeCalendar(){}function deleteCalendarEntry(){let a=parseInt(document.getElementById("calendar-row-index").value),b=document.getElementById("calendar-date").value;a>=0&&confirm("Delete this entry?")&&calendarDatabase.data.splice(a,1),clearCalendarFormEntries(),calendarTable.innerHTML=buildCalendarTableElement(b),showPlannerDiv("planner-calendar-table"),confirm("Current data updated.  Save updated data to file?")&&saveCombinedDatabase()}function cancelCalendarEntry(){let a=document.getElementById("calendar-date").value;clearCalendarFormEntries(),calendarTable.innerHTML=buildCalendarTableElement(a),showPlannerDiv("planner-calendar-table")}function clearCalendarFormEntries(){let a=calendarDatabase.headers;for(let b=0;b<a.length;b++)document.getElementById(a[b]).value="";document.getElementById("calendar-row-index").value=-1,calendarEditFormMessage.innerHTML=""}function sortCalendarByField(b){let a=document.getElementById("calendar-date").value,c=b.innerHTML;calendarDatabase.dates[a].data.length>1&&confirm("Sort by "+b.innerHTML+"?")&&(destructiveSort(calendarDatabase.dates[a].data,c,calendarSortAscending),calendarTable.innerHTML=buildCalendarTableElement(a),calendarSortAscending=-1*calendarSortAscending)}function makeCalendar(){console.log("--------------------"),console.log(monthChooser.value),console.log("--------------------");let d=new Date(monthChooser.value+"-01T00:00"),b=d.getDay(),e=parseInt(monthChooser.value.split("-")[1])-1,f=parseInt(monthChooser.value.split("-")[0]),c=daysInSomeMonth(e,f),a="<table>";a+="<tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>",a+="<tr>";for(let c=0;c<b;c++)console.log("x",daysAbbreviations[c]),a+="<td>-</td>";for(let d=0;d<c;d++){let e=d+1,f=daysAbbreviations[(d+b)%7];(d+b)%7===0&&(console.log("--------new line ----------"),a+="</tr><tr>"),a+="<td class='return-calendar-date'>"+(d+1).toString()+"</td>"}let g=(c-1+b)%7,h=6-g;for(let b=0;b<h;b++)a+="<td>-</td>";return a+="</tr></table>",document.getElementById('special-calendar').innerHTML=a,addEventListenersToCalendarEntries(),purgeCalendar(),colorCalendarEntries(),a}function addEventListenersToCalendarEntries(){let a=document.getElementsByClassName('return-calendar-date');for(let b of a)b.addEventListener("click",a=>{openDayEntry(a)})}function openDayEntry(b){let a=monthChooser.value+"-"+("0"+b.target.innerHTML).slice(-2);if(document.getElementById("calendar-date").value=a,a==="")return;document.getElementById("calendar-table-name").innerHTML=daysAbbreviations[getDayOfWeek(a)]+" "+a+"</span>",calendarTable.innerHTML=buildCalendarTableElement(a),showPlannerDiv("planner-calendar-table")}function colorCalendarEntries(){purgeCalendar();let a=document.getElementsByClassName('return-calendar-date');for(let b of a){b.style.backgroundColor="#E0E0E0;";let c=monthChooser.value+"-"+("0"+b.innerHTML).slice(-2);for(let a=0;a<calendarDatabase.data.length;a++)(c===calendarDatabase.data[a]["Start Date"]||c===calendarDatabase.data[a]["End Date"]||c>=calendarDatabase.data[a]["Start Date"]&&c<=calendarDatabase.data[a]["End Date"])&&(b.style.backgroundColor="darkorange");getTodaysDate()===c&&(b.style.border="2px solid black",b.style["font-weight"]="bold")}}function createOutlookCSV(){let a=JSONToCSV(calendarDatabase,!0,"\r\n");console.log(a),copyAndSaveString(a,"plannerToOutlookExport"+getTodaysDate(),".csv","text/csv")}function loadOutlookCSV(){if(confirm("This will add entries to the existing current calendar.\n\nIf you want to over-write all contents, please clear the calendar first, then proceed with loading the data.")){let b="",a=document.createElement('input');a.type="file",a.accept=".csv",a.addEventListener("change",function(){let d=a.files[0],c=new FileReader;c.onload=function(f){b=f.target.result,console.log(b);let e=csvToJSON(b);console.log(e);let c=e.data,a=calendarDatabase.headers,d=e.headers;for(let b=0;b<c.length;b++){let e={};console.log(c[b]);for(let d=0;d<a.length;d++)a[d]==="Start Date"||a[d]==="End Date"?e[a[d]]=outlookDateToPlannerDate(c[b][a[d]]):a[d]==="Start Time"||a[d]==="End Time"?e[a[d]]=outlookTimeToPlannerTime(c[b][a[d]]):e[a[d]]=c[b][a[d]];let f="\nAdditional Information:\n_______________________";for(let a=0;a<d.length;a++)e.hasOwnProperty(d[a])||c[b][d[a]].trim()!==""&&c[b][d[a]].trim()!=="Normal"&&(f+="\n"+d[a]+":"+c[b][d[a]]);f!=="\nAdditional Information:\n_______________________"&&(e.Description+=f.trim(),e.Description=e.Description.trim()),calendarDatabase.data.push(e)}showPlannerDiv("planner-calendar-start"),makeCalendar()},c.readAsText(d,"UTF-8")}),a.click(),console.log("loadOutlookCSV called")}}function outlookDateToPlannerDate(b){let a=b.trim().split("/");if(a.length!==3)return b;let d=("0"+a[0]).slice(-2),e=("0"+a[1]).slice(-2),f=a[2];console.log(b),console.log(a);let c=f+"-"+d+"-"+e;return console.log(c),c}function outlookTimeToPlannerTime(b){let e=!1;b.indexOf("PM")!=-1&&(e=!0);let c=b.split(":");if(!(c.length>=2))return b;let a=c[0],d=parseInt(a);e===!0&&d!==12&&(d+=12),a=d.toString(),a=("0"+a).slice(-2);let f=c[1];return a+":"+f}function clearCalendar(){confirm("Are you sure?  This will clear all calendar entries")&&(calendarDatabase={name:"Calendar",headers:["Subject","Start Date","Start Time","End Date","End Time","Description","UID"],inputTypes:{Subject:"text","Start Date":"date","Start Time":"time","End Date":"date","End Time":"time",Description:"textarea",UID:"text"},data:[]}),makeCalendar()}initializeContactsApp();function initializeContactsApp(){fillInEmptyPropertyValues(contactsTable),contactsTableElement.innerHTML=buildContactsTableElement(contactsTable),contactsEditForm.innerHTML=buildContactsEditForm(contactsTable,-1)}function backupContactsDatabase(){return JSON.parse(JSON.stringify(contactsTable))}function buildContactsTableElement(b){let a="",c=b.headers.length,d=b.data.length;a+="<table>",a+="<thead><tr>";for(let d=0;d<c;d++)a+="<th onclick='sortContactsByField(this);'>"+b.headers[d]+"</th>";a+="</tr></thead>",a+="<tbody>";for(let e=0;e<d;e++){a+="<tr id='contacts-table-row-"+e.toString()+"' onclick='selectContactsEditForm(this)'>";for(let d=0;d<c;d++){let f=b.headers[d];a+="<td><pre>"+b.data[e][f]+"</pre></td>"}a+="</tr>"}return a+="</tbody>",a}function newContactsEntry(){contactsEditFormMessage.innerHTML=contactsTable.name+": New Entry",contactsEditForm.innerHTML=buildContactsEditForm(contactsTable,-1),showPlannerDiv("planner-contacts-form")}function selectContactsEditForm(b){let a=parseInt(b.id.split("-")[3]);contactsEditFormMessage.innerHTML=contactsTable.name+": Entry "+a.toString(),contactsEditForm.innerHTML=buildContactsEditForm(contactsTable,a),showPlannerDiv("planner-contacts-form")}function buildContactsEditForm(d,e){let b="";b+="<form>",b="<input type='hidden' id='contacts-row-index' value='"+e.toString()+"'>";let g=d.headers.length,a=d.headers,f=d.data[e],c=d.inputTypes;for(let d=0;d<g;d++){let h="";if(c[a[d]]==="number"?h=" step='any' ":c[a[d]]==="tel"&&(h=" placeholder='304-424-1000' pattern='[0-9]{3}-[0-9]{3}-[0-9]{4}' "),e===-1)c[a[d]]==="textarea"?b+="<div><label for='contact-"+a[d]+"'>"+a[d]+"</label></div><div><textarea id='contact-"+a[d]+"' "+h+"></textarea></div>":b+="<div><label for='contact-"+a[d]+"'>"+a[d]+"</label></div><div><input type='"+c[a[d]]+"' id='contact-"+a[d]+"' "+h+"></div>";else if(c[a[d]]==="textarea"){let c=f[a[d]].split('"').join("&quot;").split("'").join("&apos;");b+="<div><label for='contact-"+a[d]+"'>"+a[d]+"</label></div><div><textarea id='contact-"+a[d]+"' "+h+">"+c+"</textarea></div>"}else b+="<div><label for='contact-"+a[d]+"'>"+a[d]+"</label></div><div><input type='"+c[a[d]]+"' id='contact-"+a[d]+"' value='"+f[a[d]].split('"').join("&quot;").split("'").join("&apos;")+"'"+h+"></div>"}return b+="</form>",b}function saveContactsEntry(){let c=parseInt(document.getElementById("contacts-row-index").value),a=contactsTable.headers,b={};for(let c=0;c<a.length;c++)b[a[c]]=document.getElementById("contact-"+a[c]).value;c>=0?contactsTable.data[c]=b:contactsTable.data.push(b),clearContactFormEntries(contactsTable),contactsTableElement.innerHTML=buildContactsTableElement(contactsTable),showPlannerDiv("planner-contacts-table"),confirm("Data updated.  Save updated data to file?")&&saveCombinedDatabase()}function exportSingleVCard(){let c=parseInt(document.getElementById("contacts-row-index").value),b=contactsTable.headers,a={};for(let c=0;c<b.length;c++)a[b[c]]=document.getElementById("contact-"+b[c]).value;let d=makeSingleVCFString(a);copyAndSaveString(d,a["First Name"]+"-"+a["Last Name"]+"-"+"Contact"+"-"+getTodaysDate(),".vcf","text/vcard"),c>=0?contactsTable.data[c]=a:contactsTable.data.push(a),alert("Entry also updated in contacts."),clearContactFormEntries(contactsTable),contactsTableElement.innerHTML=buildContactsTableElement(contactsTable),showPlannerDiv("planner-contacts-table")}function deleteContactsEntry(){let a=parseInt(document.getElementById("contacts-row-index").value);a>=0&&confirm("Delete this entry?")&&contactsTable.data.splice(a,1),clearContactFormEntries(contactsTable),contactsTableElement.innerHTML=buildContactsTableElement(contactsTable),showPlannerDiv("planner-contacts-table"),confirm("Current data updated.  Save updated data to file?")&&saveCombinedDatabase()}function cancelContactsEntry(){clearContactFormEntries(contactsTable),contactsTableElement.innerHTML=buildContactsTableElement(contactsTable),showPlannerDiv("planner-contacts-table")}function clearContactFormEntries(b){let a=b.headers;for(let b=0;b<a.length;b++)document.getElementById("contact-"+a[b]).value="";document.getElementById("contacts-row-index").value=-1,contactsEditFormMessage.innerHTML=""}function sortContactsByField(a){let b=a.innerHTML;contactsTable.data.length>1&&confirm("Sort by "+a.innerHTML+"?\n\nThis cannot be undone.")&&(destructiveSort(contactsTable.data,b,contactsSortAscending),contactsTableElement.innerHTML=buildContactsTableElement(contactsTable),contactsSortAscending=-1*contactsSortAscending)}function loadOutlookContactsCSV(){if(confirm("This will merge entries.\n\nIf you want to over-write all contents, please clear the contacts first, then proceed with loading the data.")){let b="",a=document.createElement('input');a.type="file",a.accept=".csv",a.addEventListener("change",function(){let d=a.files[0],c=new FileReader;c.onload=function(f){b=f.target.result,console.log(b);let d=csvToJSON(b);console.log(d);let c=d.data,e=contactsTable.headers,a=d.headers;for(let d=0;d<c.length;d++){let b={};console.log(c[d]);for(let a=0;a<e.length;a++)b[e[a]]=c[d][e[a]];let f="\r\nAdditional Information:\r\n_______________________";for(let e=0;e<a.length;e++)console.log(a[e]),b.hasOwnProperty(a[e])||c[d][a[e]].trim()===""||a[e].trim()==="Categories"||(f+="\r\n"+a[e]+":"+c[d][a[e]],console.log("extra: "+a[e]+"\n"+c[d][a[e]]));f==="\r\nAdditional Information:\r\n_______________________"?b.Notes=b.Notes.trim():(b.Notes=b.Notes.trim(),b.Notes+="\r\n"+f),contactsTable.data.push(b)}contactsTableElement.innerHTML=buildContactsTableElement(contactsTable),showPlannerDiv("planner-contacts-table")},c.readAsText(d,"UTF-8")}),a.click(),console.log("loadOutlookContactsCSV called")}}function saveOutlookContactsCSV(){let a=makeCSV(contactsTable,!0);copyAndSaveString(a,contactsTable.name+getTodaysDate(),".csv","text/csv")}function importVCF(){if(confirm("This will merge entries.\n\nIf you want to over-write all contents, please clear the contacts first, then proceed with loading the data.")){let b="",a=document.createElement('input');a.type="file",a.accept=".vcf",a.addEventListener("change",function(){let d=a.files[0],c=new FileReader;c.onload=function(a){b=a.target.result,readInAllVcards(b),contactsTableElement.innerHTML=buildContactsTableElement(contactsTable),showPlannerDiv("planner-contacts-table")},c.readAsText(d,"UTF-8")}),a.click()}}function importICSCalendar(){if(confirm("This will merge entries.  Continue?")){let b="",a=document.createElement('input');a.type="file",a.accept=".ics",a.addEventListener("change",function(){let d=a.files[0],c=new FileReader;c.onload=function(c){b=c.target.result;let a=getVEVENTSFromICS(b);for(let c=0;c<a.length;c++){let b=parseVEVENTToObject(a[c]);(b.UID===""||b.UID===void 0)&&(b.UID=makeUID(b["Start Date"],b["Start Time"])),calendarDatabase.data.push(b)}showPlannerDiv('planner-calendar-start'),makeCalendar()},c.readAsText(d,"UTF-8")}),a.click()}}function getVEVENTSFromICS(a){a.replace(/(\r\n|\r|\n)/g,"\\\n"),a=a.trim(),lines=a.split("\n");let d=[],b="",c=!1;for(let a=0;a<lines.length;a++)c===!0&&(lines[a].slice(0,10)==="END:VEVENT"?(c=!1,d.push(b),b=""):b+=lines[a]+="\n"),lines[a].slice(0,12)==="BEGIN:VEVENT"&&(c=!0);return d}function parseVEVENTToObject(b){let a={};b=b.replace(/(\r\n|\r|\n)/g,"\n"),b=b.trim();let c=b.split("\n");a.Subject="",a.Description="",a.UID="",a["Start Date"]="",a["Start Time"]="",a["End Date"]="",a["End Time"]="";let d="\n-------Extra Stuff-------\n";for(let e=0;e<c.length;e++){let b=c[e];if(b.slice(0,7)==="SUMMARY")a.Subject=b.split(":")[1];else if(b.slice(0,11)==="DESCRIPTION")a.Description=b.split(":")[1];else if(b.slice(0,3)==="UID")a.UID=b.split(":")[1];else if(b.slice(0,7)==="DTSTART"){let i=b.split(":")[1],j=iCalDateToISOString(i),c=new Date(j),f=c.getFullYear().toString(),g=("0"+(c.getMonth()+1).toString()).slice(-2),h=("0"+c.getDate().toString()).slice(-2),d=("0"+c.getHours().toString()).slice(-2),e=("0"+c.getMinutes().toString()).slice(-2),k=("0"+c.getSeconds().toString()).slice(-2);console.log("year: ",f," month: ",g," date: ",h),console.log("hours: ",d," minutes: ",e," seconds: ",k),a["Start Date"]=f+"-"+g+"-"+h,a["Start Time"]=d+":"+e}else if(b.slice(0,5)==="DTEND"){let d=b.split(":")[1],e=iCalDateToISOString(d),c=new Date(e),f=c.getFullYear().toString(),g=("0"+(c.getMonth()+1).toString()).slice(-2),h=("0"+c.getDate().toString()).slice(-2),i=("0"+c.getHours().toString()).slice(-2),j=("0"+c.getMinutes().toString()).slice(-2),k=("0"+c.getSeconds().toString()).slice(-2);a["End Date"]=f+"-"+g+"-"+h,a["End Time"]=i+":"+j}else d+=b+"\n"}return a.Description+=d,a}function iCalDateToISOString(a){let e=a.slice(0,4),f=a.slice(4,6),g=a.slice(6,8),b="00",c="00",d="00";if(a.indexOf("T")!==-1&&(b=a.slice(9,11),c=a.slice(11,13),d=a.slice(13,15)),a.indexOf("Z")!==-1){let a=e+"-"+f+"-"+g+"T"+b+":"+c+":"+d+".000Z";return a}let h=parseInt(e),i=parseInt(f),j=parseInt(g),k=parseInt(b),l=parseInt(c),m=parseInt(d),n=new Date(h,i-1,j,k,l,m);return n.toISOString()}function readInAllVcards(a){let b=a.indexOf("BEGIN:VCARD"),c=a.indexOf("END:VCARD");while(b!==-1){let d=a.substring(b,c+9),e=parseContactFromVCard(d);contactsTable.data.push(e),b=a.indexOf("BEGIN:VCARD",c),c=a.indexOf("END:VCARD",b+1)}}function parseContactFromVCard(d){d=d.trim(),d=d.replace(/;PREF/g,""),d=d.replace(/;VOICE/g,";HOME"),d=d.replace(/\r\n|\n|\r/gm,"\n");let a=d.split("\n"),c=["ADR;HOME:","EMAIL:","FN:","NOTE:","TEL;CELL:","TEL;HOME:","TEL;WORK:","N:"],g=["Home Address","E-mail Address","First Name","Notes","Mobile Phone","Home Phone","Business Phone","Last Name","Middle Name"],b={};for(let d=0;d<c.length;d++)for(j=0;j<a.length;j++)if(console.log(a[j].substring(0,3)),a[j].substring(0,3)==="TEL"&&(console.log("FOUND TEL!!!!"),a[j].indexOf("CELL")!==-1&&(console.log("Contains CELL"),b["Mobile Phone"]=a[j].split(":")[1]),a[j].indexOf("HOME")!==-1&&(console.log("Contains HOME"),b["Home Phone"]=a[j].split(":")[1]),a[j].indexOf("WORK")!==-1&&(console.log("Contains WORK"),b["Business Phone"]=a[j].split(":")[1])),a[j].substring(0,c[d].length)===c[d])if(c[d]==="N:"){let e=a[j].substring(c[d].length).split(";")[0];b["Last Name"]=e;let f=a[j].substring(c[d].length).split(";")[2];b["Middle Name"]=f;let g=a[j].substring(c[d].length).split(";")[1];b["First Name"]=g}else console.log("found match for ",c[d]),b[g[d]]=a[j].substring(c[d].length);let f=contactsTable.headers;for(let a=0;a<f.length;a++)b.hasOwnProperty(f[a])||(b[f[a]]="");let e=["ADR","AGENT","ANNIVERSARY","BDAY","CALADRURI","CALURI","CATEGORIES","CLASS","CLIENTPIDMAP","FBURL","GENDER","GEO","IMPP","KEY","KIND","LABEL","LANG","MAILER","MEMBER","NAME","NICKNAME","ORG","PRODID","PROFILE","RELATED","REV","ROLE","SORT-STRING","SOURCE","TEL","TITLE","TZ","UID","URL","XML"];for(let d=0;d<a.length;d++)if(c.includes(a[d].split(":")[0]+":"));else for(j=0;j<e.length;j++)a[d].substring(0,e[j].length)===e[j]&&(console.log("found extra ",e[j]),b.Notes+="\n"+e[j]+a[d].substring(e[j].length));return b}function exportVCF(){let a="",b=contactsTable.data;for(let c=0;c<b.length;c++)a+=makeSingleVCFString(b[c]);console.log(a),copyAndSaveString(a,"vcf"+contactsTable.name+getTodaysDate(),".vcf","text/vcard")}function makeSingleVCFString(a){let b="";console.log(a),b+="BEGIN:VCARD\n",b+="VERSION:2.1\n";let c="",d="",e="";return a["Last Name"]!==void 0&&(c=a["Last Name"],c=c.replace(/\;/g," ")),a["First Name"]!==void 0&&(d=a["First Name"],d=d.replace(/\;/g," ")),a["Middle Name"]!==void 0&&(e=a["Middle Name"],e=e.replace(/\;/g," ")),b+="N:"+c+";"+d+";"+e+";;\n",b+="FN:"+d+" "+e+" "+c+"\n",a["Mobile Phone"]!==void 0&&a["Mobile Phone"]!==""&&(b+="TEL;CELL:"+a["Mobile Phone"]+"\n"),a["Home Phone"]!==void 0&&a["Home Phone"]!==""&&(b+="TEL;HOME:"+a["Home Phone"]+"\n"),a["Business Phone"]!==void 0&&a["Business Phone"]!==""&&(b+="TEL;WORK:"+a["Business Phone"]+"\n"),a["E-mail Address"]!==void 0&&a["E-mail Address"]!==""&&(b+="EMAIL:"+a["E-mail Address"]+"\n"),a["Home Address"]!==void 0&&a["Home Address"]!==""&&(b+="ADR;HOME:"+a["Home Address"]+"\n"),a.Notes!==void 0&&a.Notes!==""&&(b+="NOTE:"+a.Notes+"\n"),b+="END:VCARD\n",b}function showPlannerDiv(a){let b=document.getElementsByClassName('planner-div');for(let a of b)a.style.display="none";document.getElementById(a).style.display="unset"}function backHomePlanner(){showPlannerDiv("planner-home"),document.getElementById("planner-ribbon").style.display="flex",document.getElementById("back-home-nav").style.display="none"}function loadCombinedDatabase(){let b="",a=document.createElement('input');a.type="file",a.accept=".json",a.addEventListener("change",function(){let d=a.files[0],c=new FileReader;c.onload=function(c){b=c.target.result,combinedDatabase=JSON.parse(b),contactsTable=combinedDatabase.contacts,calendarDatabase=combinedDatabase.calendar,calendarDatabase.headers.includes("UID")||(calendarDatabase.headers.push("UID"),calendarDatabase.inputTypes.UID="text");let a=calendarDatabase.data;for(let b=0;b<a.length;b++)(a[b].UID===""||a[b].UID===void 0)&&(a[b].UID=makeUID(a["Start Date"],a["Start Time"]));clearContactFormEntries(contactsTable),contactsTableElement.innerHTML=buildContactsTableElement(contactsTable),makeCalendar(),showPlannerDiv('planner-calendar-start')},c.readAsText(d,"UTF-8")}),a.click()}function saveCombinedDatabase(){purgeCalendar();let a=JSON.stringify(combinedDatabase),b="bitOfficePlanner"+getTodaysDate();saveStringToTextFile(a,b,".json","application/json")}function makeVEvent(a,j="\n"){let b=j;str="";let i=a.Subject,d=a["Start Date"],g=a.UID;if(d===""||d===void 0)return;let c=a["Start Time"];(c===""||c===void 0)&&(c="00:00");let e=a["End Date"];(e===""||e===void 0)&&(e=d);let f=a["End Time"];(f===""||f===void 0)&&(f=c),(g===""||g===void 0)&&(g=makeUID(d,c));let k=a.Description,l=new Date,h=l.toISOString();return h=ISOStringToICalStringZulu(h),str+="BEGIN:VEVENT"+b,str+="SUMMARY:"+i.trim()+b,rowDateTimeToICALString(d,c),rowDateTimeToICALString(e,f),str+="DTSTART:"+rowDateTimeToICALString(d,c).trim()+b,str+="DTEND:"+rowDateTimeToICALString(e,f).trim()+b,str+="DESCRIPTION:"+k.trim()+b,str+="DTSTAMP:"+h.trim()+b,str+="UID:"+g.trim()+b,str+="END:VEVENT",str}function rowDateTimeToICALString(a,b){let c=htmlDateAndTimeToISOString(a,b),d=ISOStringToICalStringZulu(c);return d;return console.log("fromhtml:"),icalStr=a.split("-").join("")+"T"+b.split(":").join(""),console.log(icalStr),icalStr}function htmlDateAndTimeToISOString(b="2023-01-31",a){(a===""||a===void 0)&&(a="00:00");let d=parseInt(b.slice(0,4)),e=parseInt(b.slice(5,7))-1,f=parseInt(b.slice(8)),g=parseInt(a.slice(0,2)),h=parseInt(a.slice(3)),c=new Date(d,e,f,g,h);return console.log("html date and time to iso string here !!!!",c.toISOString()),c.toISOString()}function ISOStringToICalStringZulu(a){let b=a.replace(/\.\d\d\dZ/,"Z").replace(/\-|\:|\./g,"");return b}function makeVEventsArr(a){let b=[];for(let c=0;c<a.length;c++)b.push(makeVEvent(a[c]).trim());return b}function makeVCalendar(c,d="\n"){let a="",b=d;a+="BEGIN:VCALENDAR"+b,a+="VERSION:2.0"+b,a+="PRODID:bitOffice"+b,a+="CALSCALE:GREGORIAN"+b;for(let d=0;d<c.length;d++)a+=c[d].trim()+b;return a+="END:VCALENDAR",a}function exportICSCalendar(){let a=makeVEventsArr(calendarDatabase.data),b=makeVCalendar(a);copyAndSaveString(b,"ICSCalendar"+getTodaysDate(),".ics","text/calendar")}function removeDuplicateContacts(){console.log("BEFORE"),console.log("number of contacts is: "+contactsTable.data.length);let a=contactsTable.data,b=[];for(let c=0;c<a.length;c++)isObjectInArray(b,a[c])||b.push(a[c]);contactsTable.data=JSON.parse(JSON.stringify(b)),contactsTableElement.innerHTML=buildContactsTableElement(contactsTable),console.log("AFTER"),console.log("number of contacts is: "+contactsTable.data.length)}function isObjectInArray(a,b){for(let c=0;c<a.length;c++)if(doObjectsHaveSameKeysAndProperties(a[c],b))return!0;return!1}function doObjectsHaveSameKeysAndProperties(c,d){let a=Object.keys(c),b=Object.keys(d);if(a.length!==b.length)return!1;for(let b=0;b<a.length;b++)if(c[a[b]]!==d[a[b]])return!1;for(let a=0;a<b.length;a++)if(d[b[a]]!==c[b[a]])return!1;return!0}